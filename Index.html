<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Repair Cafe Silicon Valley Item Tracking System">
    <title>Repair Cafe</title>   
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f6; max-width: 600px; margin: auto; }
        .tab-btn { padding: 10px; cursor: pointer; border: none; background: #606060; }
        .active { background: orange; color: white; }
        .view { display: none; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 10px; }
        .status-msg { padding: 10px; margin-bottom: 10px; border-radius: 4px; display: none; text-align: center; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .waiting { background: #d4edda; color: #000000; border: 1px solid #e2d707; }
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; box-sizing: border-box; }
        .checkbox-group { margin: 15px 0; display: flex; align-items: center; }
        .checkbox-group input { width: auto; margin-right: 10px; }
        button { background: #6f42c1; color: white; border: none; padding: 12px; width: 100%; cursor: pointer; border-radius: 4px; }
        #statFixed { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>

    <div id="statusBox" class="status-msg"></div>

    <button class="tab-btn active" onclick="showView('intake')">Intake Item</button>
    <button class="tab-btn" onclick="showView('update')">Update Item</button>
    <button class="tab-btn" onclick="showView('dashboard'); loadStats();">Stats</button>

    <div id="intake" class="view" style="display:block;">
        <h3>New Intake</h3>
        <input id="clientName" placeholder="Client Name">
        <input id="email" placeholder="Email Address">
        <select id="category" title="Select Category">
            <option value="" disabled selected>Select Category</option>
            <option value="Bike">Bike</option>
            <option value="Sewing">Sewing</option>
            <option value="Jewelry">Jewelry</option>
            <option value="Simple Electronics">Small Electrical Appliance</option>
            <option value="Complex Electronics">Complex Electronics - Radio/CD/VCR</option>
            <option value="Computer/Phone">Computer/Phone</option>
            <option value="Mechanical">Mechanical</option>
            <option value="Other">Other</option>
        </select>
        <input id="itemName" placeholder="Item Name (e.g. Toaster)">
        <textarea id="issue" placeholder="Describe the problem..."></textarea>
        
        <div class="checkbox-group">
            <input type="checkbox" id="mailingList"> <label for="mailingList">Add to mailing list?</label>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="clientIsFixer"> <label for="clientIsFixer">Client is a volunteer fixer?</label>
        </div>
        
        <button onclick="submitIntake()">Check In Item</button>
        <button onclick="submitIntakeAndAddAnother()" style="background: #28a745; margin-top: 10px;">Check In and Add Another for Same Client</button>
    </div>

    <div id="update" class="view">
        <h3>Update Item</h3>
        <input id="searchId" placeholder="Scan or Enter Item ID">
        <button onclick="findItem()" style="background:#555">Look Up Item</button>
        
        <div id="repairForm" style="display:none; margin-top:20px; border-top: 1px solid #eee; padding-top: 20px;">
            <p><strong>Item:</strong> <span id="dispItem"></span> (<span id="dispCat"></span>)</p>
            <p><strong>Client:</strong> <span id="dispClient"></span></p>
            <p><strong>Issue:</strong> <i id="dispIssue"></i></p>
            
            <input id="fixerName" placeholder="Fixer Name">
            <div style="margin: 15px 0;">
                <div class="checkbox-group">
                    <input type="radio" id="resolutionFixed" name="resolution" value="Fixed">
                    <label for="resolutionFixed">Fixed!</label>
                </div>
                <div class="checkbox-group">
                    <input type="radio" id="resolutionDiagnosed" name="resolution" value="Diagnosed">
                    <label for="resolutionDiagnosed">Diagnosed Issue</label>
                </div>
                <div class="checkbox-group">
                    <input type="radio" id="resolutionAdvised" name="resolution" value="Advised">
                    <label for="resolutionAdvised">Advised Client</label>
                </div>
                <div class="checkbox-group">
                    <input type="radio" id="resolutionNotFound" name="resolution" value="Client Not Found">
                    <label for="resolutionNotFound">Client Not Found</label>
                </div>
            </div>
            <textarea id="notes" rows="4" placeholder="Repair notes / Parts used..."></textarea>
            <input type="hidden" id="currentRow">
            <button onclick="submitUpdate()">Log Item Resolution</button>
        </div>
    </div>

    <div id="dashboard" class="view">
        <h3>Live Activity Summary</h3>
        <p>Total Checked In: <span id="statTotal">0</span></p>
        <p>Fixed: <span id="statFixed">0</span></p>
        <p>Diagnosed: <span id="statDiagnosed">0</span></p>
        <p>Advised: <span id="statAdvised">0</span></p>
        <p>Client Not Found: <span id="statNotFound">0</span></p>
    </div>

    <script>
        function setStatus(msg, type) {
            const box = document.getElementById('statusBox');
            box.innerText = msg;
            box.className = 'status-msg ' + type;
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 10000);
        }

        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).style.display = 'block';
            event.target.classList.add('active');
        }

        function submitIntake() {
            const data = {
                clientName: document.getElementById('clientName').value,
                email: document.getElementById('email').value,
                category: document.getElementById('category').value,
                itemName: document.getElementById('itemName').value,
                issue: document.getElementById('issue').value,
                mailingList: document.getElementById('mailingList').checked,
                clientIsFixer: document.getElementById('clientIsFixer').checked
            };
            
            setStatus('Submitting item...', 'waiting');

            google.script.run
                .withSuccessHandler(res => {
                    setStatus(res, 'success');
                    // Clear inputs on success
                    document.querySelectorAll('#intake input:not([type="checkbox"]), #intake textarea, #intake select').forEach(i => i.value = '');
                    document.querySelectorAll('#intake input[type="checkbox"]').forEach(i => i.checked = false);
                })
                .withFailureHandler(err => {
                    // This catches the 'throw new Error' from the server
                    setStatus(err.message, 'error');
                })
                .processNewIntake(data);
        }

        function submitIntakeAndAddAnother() {
            const data = {
                clientName: document.getElementById('clientName').value,
                email: document.getElementById('email').value,
                category: document.getElementById('category').value,
                itemName: document.getElementById('itemName').value,
                issue: document.getElementById('issue').value,
                mailingList: document.getElementById('mailingList').checked,
                clientIsFixer: document.getElementById('clientIsFixer').checked
            };
            
            setStatus('Submitting item...', 'waiting');

            google.script.run
                .withSuccessHandler(res => {
                    // Extract ID from response message (format: "Success! Item {ID} has been registered.")
                    const idMatch = res.match(/Item (\d+)/);
                    const itemId = idMatch ? idMatch[1] : 'unknown';
                    setStatus('Item ' + itemId + ' checked in! Ready for next item.', 'success');
                    
                    // Clear form fields EXCEPT client name and email
                    document.getElementById('category').value = '';
                    document.getElementById('itemName').value = '';
                    document.getElementById('issue').value = '';
                    document.getElementById('mailingList').checked = false;
                    document.getElementById('clientIsFixer').checked = false;
                    
                    // Focus on category field to prepare for next input
                    document.getElementById('category').focus();
                })
                .withFailureHandler(err => {
                    // This catches the 'throw new Error' from the server
                    setStatus(err.message, 'error');
                })
                .processNewIntake(data);
        }

        function findItem() {
          const id = document.getElementById('searchId').value;
          setStatus('Searching for item ' + id + '...', 'waiting');

            document.getElementById('repairForm').style.display = 'none';
            
            google.script.run.withSuccessHandler(res => {
                document.getElementById('dispClient').innerText = res.clientName;
                document.getElementById('dispItem').innerText = res.itemName;
                document.getElementById('dispCat').innerText = res.category;
                document.getElementById('dispIssue').innerText = res.issue;
                document.getElementById('fixerName').value = res.fixerName;
                // Set the radio button based on resolution value
                const resolutionRadios = document.querySelectorAll('input[name="resolution"]');
                resolutionRadios.forEach(radio => {
                    radio.checked = (radio.value === res.resolution);
                });
                document.getElementById('notes').value = res.notes;
                document.getElementById('currentRow').value = res.rowIndex;
                document.getElementById('repairForm').style.display = 'block';
            }).withFailureHandler(err => setStatus(err, 'error')).lookupItem(id);
        }

        function submitUpdate() {
            setStatus('Updating item...', 'waiting');
            const checkedResolution = document.querySelector('input[name="resolution"]:checked');
            const data = {
                itemId: document.getElementById('searchId').value,
                rowIndex: document.getElementById('currentRow').value,
                fixerName: document.getElementById('fixerName').value,
                resolution: checkedResolution ? checkedResolution.value : '',
                notes: document.getElementById('notes').value
            };
            google.script.run.withSuccessHandler(res => {
                setStatus(res, 'success');
                document.getElementById('repairForm').style.display = 'none';
                document.getElementById('searchId').value = '';
            }).processRepairUpdate(data);
        }

        function loadStats() {
          setStatus('Loading statistics...', 'waiting');

            google.script.run.withSuccessHandler(stats => {
                const total = stats.total || 0;
                const withPct = count => {
                    if (!total) return `${count} (0%)`;
                    const pct = Math.round((count / total) * 1000) / 10; // one decimal place
                    return `${count} (${pct}%)`;
                };

                document.getElementById('statTotal').innerText = total;
                document.getElementById('statFixed').innerText = withPct(stats.fixed);
                document.getElementById('statDiagnosed').innerText = withPct(stats.diagnosed);
                document.getElementById('statAdvised').innerText = withPct(stats.advised);
                document.getElementById('statNotFound').innerText = withPct(stats.notfound);
                document.getElementById('statusBox').style.display = 'none';
            }).getStats();
        }
    </script>
</body>
</html>